<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë³µì§€ ì •ë³´ ê°„í¸ ì¡°ì‚¬ (DB í‚¤ 100% ì¼ì¹˜)</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />

    <style>
      /* ë³€ìˆ˜ ì„¤ì •: ë©”ì¸ ìƒ‰ìƒ #ff6000 (ì„ ëª…í•œ ì˜¤ë Œì§€) ì ìš© */
      :root {
        --primary-color: #ff6000;
        --primary-hover: #e65600;
        --light-orange-hover: #ffe5db;
        --accent-color: #4caf50;
        --bg-color: #ffffff;
        --border-color: #f0f0f0;
        --shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.05);
        --transition-speed: 0.3s;
      }

      body {
        font-family: "Malgun Gothic", "Apple SD Gothic Neo", Arial, sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }

      .container {
        width: 100%;
        max-width: 500px;
        margin-top: 0;
        background: var(--bg-color);
        padding: 20px 24px;
        border-radius: 0;
        box-shadow: none;
        min-height: 100vh;
      }
      @media (min-width: 501px) {
        .container {
          margin-top: 30px;
          border-radius: 16px;
          box-shadow: var(--shadow-soft);
          min-height: auto;
        }
      }

      h2 {
        font-size: 20px;
        color: #333;
        text-align: center;
        margin: 20px 0 30px 0;
        font-weight: 700;
      }

      /* --- Flatpickr Styles (ìœ ì§€) --- */
      .flatpickr-months .flatpickr-month {
        height: 52px;
      }
      .flatpickr-current-month .flatpickr-monthDropdown-months {
        height: 40px;
        min-height: 40px;
      }
      .flatpickr-current-month input.cur-year {
        height: 40px;
        min-height: 40px;
      }
      .flatpickr-calendar .flatpickr-current-month {
        height: 47px !important;
        padding-top: 5px !important;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .flatpickr-calendar .flatpickr-months .flatpickr-prev-month,
      .flatpickr-calendar .flatpickr-months .flatpickr-next-month {
        display: flex;
        align-items: center;
      }

      .flatpickr-day.selected,
      .flatpickr-day.selected:hover,
      .flatpickr-day.today.selected,
      .flatpickr-day.today.selected:hover,
      .flatpickr-day.startRange,
      .flatpickr-day.endRange,
      .flatpickr-day.startRange:hover,
      .flatpickr-day.endRange:hover,
      .flatpickr-day.inRange {
        background: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
        color: #fff !important;
      }
      .flatpickr-day:hover,
      .flatpickr-day:focus,
      .flatpickr-day.prevMonthDay:hover,
      .flatpickr-day.nextMonthDay:hover,
      .flatpickr-day.prevMonthDay:focus,
      .flatpickr-day.nextMonthDay:focus {
        background: var(--light-orange-hover) !important;
        border-color: var(--light-orange-hover) !important;
        color: #333 !important;
      }
      .flatpickr-day.today {
        border-color: var(--primary-color) !important;
      }
      .flatpickr-current-month .flatpickr-monthDropdown-months,
      .flatpickr-month,
      .flatpickr-current-month .numInputWrapper span.arrowUp:after,
      .flatpickr-current-month .numInputWrapper span.arrowDown:after {
        color: var(--primary-color) !important;
      }
      .flatpickr-calendar .flatpickr-months .flatpickr-prev-month svg path,
      .flatpickr-calendar .flatpickr-months .flatpickr-next-month svg path {
        fill: var(--primary-color) !important;
      }

      /* --- ì¼ë°˜ CSS (ìœ ì§€) --- */
      .progress-container {
        padding: 0;
        margin-bottom: 30px;
      }
      .progress-bar {
        height: 8px;
        background-color: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        width: 20%;
        background-color: var(--primary-color);
        transition: width var(--transition-speed) ease-in-out;
      }
      .step-indicators {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        font-size: 12px;
        color: #999 !important;
        font-weight: 500;
      }
      .step-indicators span.active {
        font-weight: 700;
        color: var(--primary-color);
      }

      .step h3 {
        font-size: 18px;
        color: #333;
        padding-left: 0;
        margin-bottom: 25px;
        font-weight: 700;
      }
      .form-group {
        margin-bottom: 24px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #444;
        font-size: 15px;
      }
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 14px 16px;
        min-height: 52px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-sizing: border-box;
        font-size: 16px;
        color: #333;
        transition: border-color var(--transition-speed),
          box-shadow var(--transition-speed);
      }

      input.flatpickr-input:focus,
      input[type="text"]:focus,
      input[type="number"]:focus,
      select:focus,
      textarea:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 1px var(--primary-color);
      }

      .chip-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      .chip-group input[type="checkbox"] {
        display: none;
      }
      .chip-group label.chip {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #555;
        background-color: #f7f7f7;
        transition: all 0.2s;
        user-select: none;
        text-align: center;
      }
      .chip-group input[type="checkbox"]:checked + label.chip {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        font-weight: 600;
      }

      /* ğŸš¨ ì¶”ê°€: ì°¨ìƒìœ„ ê³„ì¸µ ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
      .checkbox-group {
        display: flex;
        align-items: center;
        background-color: #f7f7f7;
        padding: 15px;
        border-radius: 12px;
        border: 1px solid #eee;
      }
      .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        accent-color: var(--primary-color);
        display: inline-block;
      }
      .checkbox-group label {
        margin: 0;
        font-weight: 600;
        color: #333;
        font-size: 15px;
      }

      .child-item {
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #fafafa;
      }
      .child-item h4 {
        margin-top: 10px;
        color: var(--primary-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
        font-size: 16px;
        font-weight: 600;
      }
      .delete-child-btn {
        float: right;
        background: #fff;
        color: #ff4d4d;
        border: 1px solid #ff4d4d;
        padding: 5px 10px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 10px;
      }

      #add_child_btn {
        background-color: #f7f7f7;
        color: #333;
        padding: 12px 18px;
        border: 1px solid #ddd;
        border-radius: 10px;
        cursor: pointer;
        margin-bottom: 20px;
        font-weight: 600;
      }

      .button-group {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 40px;
        padding-bottom: 20px;
      }
      .button-group button {
        flex-grow: 1;
        padding: 16px 20px;
        min-height: 54px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 17px;
        font-weight: 700;
        transition: background-color var(--transition-speed);
      }
      .next-btn {
        background-color: var(--primary-color);
        color: white;
      }
      .next-btn:hover {
        background-color: var(--primary-hover);
      }
      .prev-btn {
        background-color: #e0e0e0;
        color: #666;
      }
      .prev-btn:hover {
        background-color: #d0d0d0;
      }
      .submit-btn {
        background-color: var(--accent-color);
        color: white;
      }

      .step {
        display: none;
        animation: fadeIn 0.5s ease-out;
      }
      .step.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .input-error {
        border: 2px solid #ff4d4d !important;
      }
      .radio-group label {
        margin-right: 15px;
        display: inline-block;
        font-weight: 400;
      }

      /* ======================================= */
      /* ğŸš¨ 768px ë¯¸ë§Œ ëª¨ë°”ì¼ í™”ë©´ ë°˜ì‘í˜• ìµœì í™” */
      /* ======================================= */
      @media (max-width: 767px) {
        .container {
          padding: 20px 16px; /* ì¢Œìš° ì—¬ë°± ì¤„ì´ê¸° */
        }

        /* Step Indicators: ê¸€ì í¬ê¸° ì¡°ì • ë° ê°„ê²© ì¤„ì´ê¸° */
        .step-indicators {
          font-size: 11px;
          gap: 5px;
        }
        .step-indicators span {
          flex: 1 1 0;
          text-align: center;
        }

        /* Form Group: ì—¬ë°± ì¤„ì´ê¸° */
        .form-group {
          margin-bottom: 18px;
        }

        /* ì œëª© í°íŠ¸ í¬ê¸° ì¡°ì • */
        .step h3 {
          font-size: 17px;
          margin-bottom: 20px;
        }

        /* Input/Select/Textarea: ë†’ì´ ì•½ê°„ ì¤„ì´ê³  í°íŠ¸ í¬ê¸° ì¡°ì • */
        input[type="text"],
        input[type="number"],
        select,
        textarea {
          padding: 12px 14px;
          min-height: 48px;
          font-size: 15px;
          border-radius: 10px;
        }

        /* Chip Group: ì¹© í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • ë° íŒ¨ë”© ì¤„ì´ê¸° */
        .chip-group label.chip {
          padding: 8px 12px;
          font-size: 13px;
        }

        /* ë²„íŠ¼ ê·¸ë£¹: íŒ¨ë”© ì¡°ì • */
        .button-group {
          gap: 8px;
          margin-top: 30px;
        }
        .button-group button {
          padding: 14px 18px;
          min-height: 50px;
          font-size: 16px;
        }

        /* Checkbox Group (ì°¨ìƒìœ„ ê³„ì¸µ): íŒ¨ë”© ì¤„ì´ê¸° */
        .checkbox-group {
          padding: 12px;
        }
        .checkbox-group label {
          font-size: 14px;
        }

        /* ìë…€ í•­ëª© íŒ¨ë”© ì¤„ì´ê¸° */
        .child-item {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>ì§€ì›ê¸ˆ ê³„ì‚°ê¸°</h2>

      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-bar-fill"></div>
        </div>
        <div class="step-indicators" id="step-indicators">
          <span data-indicator="1" class="active">1. ê¸°ë³¸/ê±°ì£¼</span>
          <span data-indicator="2">2. ê²½ì œ ì •ë³´</span>
          <span data-indicator="3">3. ìë…€ ì •ë³´</span>
          <span data-indicator="4">4. ë³´í˜¸ì ì •ë³´</span>
          <span data-indicator="5">5. íŠ¹ìˆ˜ ìƒí™©</span>
        </div>
      </div>

      <form id="multiStepForm">
        <div class="step active" data-step="1">
          <h3>
            1. ê°€êµ¬ ê¸°ë³¸ ì •ë³´
            <span style="font-size: 13px; color: #ff6000">(í•„ìˆ˜ ì…ë ¥)</span>
          </h3>
          <div class="form-group">
            <label for="sido">ê±°ì£¼ì§€ (ì‹œë„ â†’ ì‹œêµ°êµ¬)</label>
            <div style="display: flex; gap: 10px">
              <select
                id="sido"
                name="sido"
                data-required="true"
                style="flex: 1"
              >
                <option value="">ì‹œ/ë„ ì„ íƒ</option>
                <option value="ì„œìš¸íŠ¹ë³„ì‹œ">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                <option value="ê²½ê¸°ë„">ê²½ê¸°ë„</option>
                <option value="ë¶€ì‚°ê´‘ì—­ì‹œ">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
                <option value="ì¸ì²œê´‘ì—­ì‹œ">ì¸ì²œê´‘ì—­ì‹œ</option>
                <option value="ìš¸ì‚°ê´‘ì—­ì‹œ">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
              </select>
              <select
                id="sigungu"
                name="sigungu"
                data-required="true"
                style="flex: 1"
              >
                <option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="residence_start_date"
              >ê±°ì£¼ ì‹œì‘ì¼ (ì „ì…ì¼)
              <!-- - ê¸°ê°„ ê³„ì‚°ìš© -->
            </label>
            <input
              type="text"
              id="residence_start_date"
              name="residence_start_date"
              data-required="true"
              class="flatpickr-input"
              placeholder="YYYY-MM-DD"
            />
          </div>

          <div class="form-group">
            <label for="residence_min_months"
              >ì‹¤ì œ ê±°ì£¼ ê¸°ê°„ (ê°œì›”)
              <!-- - DB ì»¬ëŸ¼ëª… (ìˆ«ì íƒ€ì…ìœ¼ë¡œ ë³€í™˜ë¨) -->
            </label>
            <input
              type="number"
              id="residence_min_months"
              name="residence_min_months"
              data-required="true"
              min="1"
              placeholder="ì˜ˆ: 12 (1ë…„ ê±°ì£¼ ì‹œ)"
            />
          </div>

          <div class="form-group">
            <label
              >ê°€êµ¬ í˜•íƒœ ì„ íƒ
              <!-- (DB ì»¬ëŸ¼: household_type - ë°°ì—´ë¡œ ë³€í™˜ë¨) -->
            </label>
            <div class="chip-group">
              <input
                type="checkbox"
                id="household_single_parent"
                name="household_type[]"
                value="í•œë¶€ëª¨ê°€ì¡±"
              />
              <label for="household_single_parent" class="chip"
                >í•œë¶€ëª¨ê°€ì¡±</label
              >
              <input
                type="checkbox"
                id="household_grandchild"
                name="household_type[]"
                value="ì¡°ì†ê°€ì¡±"
              />
              <label for="household_grandchild" class="chip">ì¡°ì†ê°€ì¡±</label>
              <input
                type="checkbox"
                id="household_multiculture"
                name="household_type[]"
                value="ë‹¤ë¬¸í™”ê°€ì¡±"
              />
              <label for="household_multiculture" class="chip"
                >ë‹¤ë¬¸í™”ê°€ì¡±</label
              >
              <input
                type="checkbox"
                id="household_double_income"
                name="household_type[]"
                value="ë§ë²Œì´"
              />
              <label for="household_double_income" class="chip">ë§ë²Œì´</label>
            </div>
          </div>
        </div>

        <div class="step" data-step="2">
          <h3>
            2. ê²½ì œ ìƒí™© ì •ë³´
            <span style="font-size: 13px; color: #ff6000">(í•„ìˆ˜ ì…ë ¥)</span>
          </h3>

          <div class="form-group">
            <label for="household_members_count"
              >ì´ ê°€êµ¬ì› ìˆ˜
              <!-- (ì†Œë“ ê¸°ì¤€ ê³„ì‚°ì— ì‚¬ìš©) -->
            </label>
            <input
              type="number"
              id="household_members_count"
              name="household_members_count"
              data-required="true"
              min="1"
              placeholder="ê°€êµ¬ì› ìˆ˜ (1~7ì¸)"
            />
          </div>

          <div class="form-group">
            <label for="monthly_income">ì›” ê°€êµ¬ì†Œë“ ì…ë ¥ (ì„¸ì „, ì›)</label>
            <input
              type="text"
              id="monthly_income"
              name="monthly_income"
              data-required="true"
              placeholder="ì˜ˆ: 3500000 (ì‰¼í‘œ ì—†ì´ ìˆ«ìë§Œ ì…ë ¥)"
            />
          </div>

          <div class="form-group">
            <label
              >ì°¨ìƒìœ„ê³„ì¸µ í•´ë‹¹ ì—¬ë¶€
              <!-- (ì„ íƒ ì‹œ ì†Œë“ ê¸°ì¤€ 50% ì´í•˜ì¼ ê²½ìš° **ì°¨ìƒìœ„**ë¡œ ë¶„ë¥˜ë¨) -->
            </label>
            <div class="checkbox-group">
              <input
                type="checkbox"
                id="is_near_poverty"
                name="is_near_poverty"
                value="true"
              />
              <label for="is_near_poverty"
                >í˜„ì¬ ì°¨ìƒìœ„ ê³„ì¸µì— í•´ë‹¹í•©ë‹ˆë‹¤.</label
              >
            </div>
          </div>

          <div class="form-group">
            <label for="housing_type"
              >ì£¼ê±° í˜•íƒœ
              <!-- (DB ì»¬ëŸ¼: housing_type) -->
            </label>
            <select id="housing_type" name="housing_type" data-required="true">
              <option value="">ì£¼ê±° í˜•íƒœ ì„ íƒ</option>
              <option value="ìê°€">ìê°€</option>
              <option value="ì „ì„¸">ì „ì„¸</option>
              <option value="ì›”ì„¸">ì›”ì„¸</option>
              <option value="ë¬´ë£Œì„ì°¨">ë¬´ë£Œ ì„ì°¨</option>
            </select>
          </div>

          <div
            class="form-group"
            style="
              background-color: #fff8f5 !important;
              padding: 15px;
              border-radius: 10px;
            "
          >
            <label>â–¶ ì†Œë“ ì¡°ê±´ ë§¤í•‘ ê²°ê³¼ (ìë™ ê³„ì‚° ë° ì •ê·œí™”)</label>
            <p
              style="margin: 0; font-weight: 500; font-size: 14px; color: #555"
            >
              (ì…ë ¥ ì†Œë“, ê°€êµ¬ì› ìˆ˜, ì°¨ìƒìœ„ê³„ì¸µ ì—¬ë¶€ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì†Œë“ë¶„ìœ„ê°€
              <!-- **`income_type`** ë° **`income_max_percent`**ê°€ ì •í™•íˆ -->
              ì¶”ì •ë©ë‹ˆë‹¤.)
            </p>
          </div>
        </div>

        <div class="step" data-step="3">
          <h3>
            3. ìë…€ ìƒì„¸ ì •ë³´
            <span style="font-size: 13px; color: #ff6000"
              >(ëª¨ë“  ìë…€ í•„ìˆ˜ ì…ë ¥)</span
            >
          </h3>

          <div class="form-group">
            <label
              >â–¶ ì„ì‹ /ì¶œì‚° ìƒí™©
              <!-- (DB ì»¬ëŸ¼: pregnancy_weeks_min/max, birth_within_months, birth_special) -->
            </label>
            <div class="chip-group" id="pregnancy_chips">
              <input
                type="checkbox"
                id="pregnancy_current"
                name="pregnancy_status[]"
                value="current"
              />
              <label for="pregnancy_current" class="chip">í˜„ì¬ ì„ì‹  ì¤‘</label>
              <input
                type="checkbox"
                id="pregnancy_recent"
                name="pregnancy_status[]"
                value="recent"
              />
              <label for="pregnancy_recent" class="chip"
                >ìµœê·¼ ì¶œì‚° (1ë…„ ì´ë‚´)</label
              >
              <input
                type="checkbox"
                id="pregnancy_multiple"
                name="pregnancy_status[]"
                value="multiple"
              />
              <label for="pregnancy_multiple" class="chip"
                >ë‹¤íƒœì•„/íŠ¹ìˆ˜ì¶œìƒ</label
              >
            </div>
          </div>

          <div id="child_input_area">
            <div class="child-item" data-child="1">
              <div style="clear: both"></div>
              <h4>
                ìë…€ 1
                <!-- (ëŒ€í‘œ ìë…€ë¡œ ì¡°ê±´ ë§¤í•‘) -->
              </h4>

              <div class="form-group">
                <label for="child1_birth_date">ì¶œìƒì¼ (YYYY-MM-DD)</label>
                <input
                  type="text"
                  id="child1_birth_date"
                  name="child1_birth_date"
                  data-required-group="child"
                  class="flatpickr-input"
                  placeholder="YYYY-MM-DD"
                />
              </div>

              <div class="form-group">
                <label for="child1_school"
                  >ì¬í•™/êµìœ¡ ìƒíƒœ
                  <!-- (DB ì»¬ëŸ¼: education_level, is_enrolled) -->
                </label>
                <select id="child1_school" name="child1_school">
                  <option value="newborn">ë¯¸ë“±ë¡/ì˜ìœ ì•„ (ë§Œ 0~2ì„¸)</option>
                  <option value="preschool">
                    ë¯¸ì·¨í•™ (ì–´ë¦°ì´ì§‘/ìœ ì¹˜ì› ì¬ì›)
                  </option>
                  <option value="elementary">ì´ˆë“±</option>
                  <option value="middle">ì¤‘ë“±</option>
                  <option value="high">ê³ ë“±</option>
                  <option value="university">ëŒ€í•™êµ</option>
                </select>
              </div>

              <div class="form-group">
                <label for="child1_disability"
                  >ì¥ì•  ì—¬ë¶€
                  <!-- (DB ì»¬ëŸ¼: requires_disability, disability_level) -->
                </label>
                <select id="child1_disability" name="child1_disability">
                  <option value="N">í•´ë‹¹ ì—†ìŒ</option>
                  <option value="Y_severe">ì¥ì• ì¸ (ì¤‘ì¦)</option>
                  <option value="Y_mild">ì¥ì• ì¸ (ê²½ì¦)</option>
                </select>
              </div>

              <div class="form-group">
                <label
                  >ì•„ë™ ì§ˆí™˜
                  <!-- (DB ì»¬ëŸ¼: child_has_*_disease) -->
                </label>
                <div class="chip-group" id="child1_health_chips">
                  <input
                    type="checkbox"
                    id="child1_health_none"
                    name="child1_health[]"
                    value="none"
                    checked
                  />
                  <label for="child1_health_none" class="chip">í•´ë‹¹ ì—†ìŒ</label>

                  <input
                    type="checkbox"
                    id="child1_health_serious"
                    name="child1_health[]"
                    value="serious"
                  />
                  <label for="child1_health_serious" class="chip"
                    >ì¤‘ì¦ ì§ˆí™˜</label
                  >

                  <input
                    type="checkbox"
                    id="child1_health_rare"
                    name="child1_health[]"
                    value="rare"
                  />
                  <label for="child1_health_rare" class="chip">í¬ê·€ ì§ˆí™˜</label>

                  <input
                    type="checkbox"
                    id="child1_health_chronic"
                    name="child1_health[]"
                    value="chronic"
                  />
                  <label for="child1_health_chronic" class="chip"
                    >ë‚œì¹˜ ì§ˆí™˜</label
                  >

                  <input
                    type="checkbox"
                    id="child1_health_cancer"
                    name="child1_health[]"
                    value="cancer"
                  />
                  <label for="child1_health_cancer" class="chip"
                    >ì•”/ë°±í˜ˆë³‘</label
                  >

                  <input
                    type="checkbox"
                    id="child1_health_infertility"
                    name="child1_health[]"
                    value="infertility"
                  />
                  <label for="child1_health_infertility" class="chip"
                    >ë‚œì„ (ê·¹íˆ ë“œë¬¾)</label
                  >
                </div>
              </div>
            </div>
          </div>
          <button type="button" id="add_child_btn" style="float: right">
            + ìë…€ ì¶”ê°€
          </button>
          <div style="clear: both"></div>
        </div>

        <div class="step" data-step="4">
          <h3>4. ë¶€ëª¨/ë³´í˜¸ì ìƒì„¸ ì •ë³´</h3>
          <div class="form-group">
            <label for="parent_disability"
              >ë¶€ëª¨/ë³´í˜¸ì ì¥ì•  ì—¬ë¶€
              <!-- (DB ì»¬ëŸ¼: requires_parent_disability, parent_disability_level) -->
            </label>
            <select id="parent_disability" name="parent_disability">
              <option value="N">ì—†ìŒ</option>
              <option value="Y_severe">ì¥ì• ì¸ (ì¤‘ì¦)</option>
              <option value="Y_mild">ì¥ì• ì¸ (ê²½ì¦)</option>
            </select>
          </div>

          <div class="form-group">
            <label
              >ë¶€ëª¨/ë³´í˜¸ì ì§ˆí™˜
              <!-- (DB ì»¬ëŸ¼: parent_has_*_disease) -->
            </label>
            <div class="chip-group" id="parent_health_chips">
              <input
                type="checkbox"
                id="parent_health_none"
                name="parent_health[]"
                value="none"
                checked
              />
              <label for="parent_health_none" class="chip">í•´ë‹¹ ì—†ìŒ</label>
              <input
                type="checkbox"
                id="parent_health_serious"
                name="parent_health[]"
                value="serious"
              />
              <label for="parent_health_serious" class="chip">ì¤‘ì¦ ì§ˆí™˜</label>
              <input
                type="checkbox"
                id="parent_health_rare"
                name="parent_health[]"
                value="rare"
              />
              <label for="parent_health_rare" class="chip">í¬ê·€ ì§ˆí™˜</label>
              <input
                type="checkbox"
                id="parent_health_chronic"
                name="parent_health[]"
                value="chronic"
              />
              <label for="parent_health_chronic" class="chip">ë‚œì¹˜ ì§ˆí™˜</label>
              <input
                type="checkbox"
                id="parent_health_cancer"
                name="parent_health[]"
                value="cancer"
              />
              <label for="parent_health_cancer" class="chip">ì•”</label>
              <input
                type="checkbox"
                id="parent_health_infertility"
                name="parent_health[]"
                value="infertility"
              />
              <label for="parent_health_infertility" class="chip">ë‚œì„</label>
            </div>
          </div>

          <div class="form-group">
            <label
              >ì¡°ë¶€ëª¨ ì–‘ìœ¡ í•„ìš” ì—¬ë¶€
              <!-- (DB ì»¬ëŸ¼: requires_grandparent_care) -->
            </label>
            <div class="radio-group">
              <label
                ><input
                  type="radio"
                  name="requires_grandparent_care"
                  value="1"
                />
                ì˜ˆ</label
              >
              <label
                ><input
                  type="radio"
                  name="requires_grandparent_care"
                  value="0"
                  checked
                />
                ì•„ë‹ˆì˜¤</label
              >
            </div>
          </div>
        </div>

        <div class="step" data-step="5">
          <h3>
            5. íŠ¹ìˆ˜ ìƒí™©
            <!-- (DB ì»¬ëŸ¼: is_*_...) -->
          </h3>

          <div class="form-group">
            <label>ê¸°íƒ€ íŠ¹ìˆ˜ ìƒí™© (ë‹¤ì¤‘ì„ íƒ ê°€ëŠ¥)</label>
            <div class="chip-group">
              <input
                type="checkbox"
                id="special_violence"
                name="special_status[]"
                value="violence_victim"
              />
              <label for="special_violence" class="chip">í­ë ¥/í•™ëŒ€ í”¼í•´</label>

              <input
                type="checkbox"
                id="special_defector"
                name="special_status[]"
                value="defector"
              />
              <label for="special_defector" class="chip"
                >íƒˆë¶ë¯¼/ë¶í•œì´íƒˆì£¼ë¯¼</label
              >

              <input
                type="checkbox"
                id="special_veteran"
                name="special_status[]"
                value="veteran"
              />
              <label for="special_veteran" class="chip"
                >êµ­ê°€ìœ ê³µì/ë³´í›ˆëŒ€ìƒì</label
              >

              <input
                type="checkbox"
                id="special_foster"
                name="special_status[]"
                value="foster_child"
              />
              <label for="special_foster" class="chip">ìœ„íƒì•„ë™</label>

              <input
                type="checkbox"
                id="special_unmarried"
                name="special_status[]"
                value="unmarried_mother"
              />
              <label for="special_unmarried" class="chip">ë¯¸í˜¼ëª¨</label>

              <input
                type="checkbox"
                id="special_low_income"
                name="special_status[]"
                value="low_income"
              />
              <label for="special_low_income" class="chip"
                >ì €ì†Œë“ì¸µ (ì°¨ìƒìœ„/ê¸°ì´ˆ ì™¸)</label
              >
            </div>
          </div>

          <div class="form-group">
            <label for="special_other"
              >ê¸°íƒ€ ì¡°ê±´ (ììœ  ì„œìˆ ) - DB ì»¬ëŸ¼: special_other</label
            >
            <textarea
              id="special_other"
              name="special_other"
              rows="5"
              placeholder="ê¸°íƒ€ ì¡°ê±´ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”."
            ></textarea>
          </div>
        </div>

        <div class="button-group">
          <button
            type="button"
            class="prev-btn"
            id="prevBtn"
            style="display: none"
          >
            ì´ì „
          </button>
          <button type="button" class="next-btn" id="nextBtn">ë‹¤ìŒ ë‹¨ê³„</button>
          <button
            type="submit"
            class="submit-btn"
            id="submitBtn"
            style="display: none"
          >
            âœ… ê²°ê³¼ í™•ì¸
          </button>
        </div>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

    <script>
      const form = document.getElementById("multiStepForm");
      const steps = document.querySelectorAll(".step");
      const progressFill = document.getElementById("progress-bar-fill");
      const stepIndicators = document
        .getElementById("step-indicators")
        .querySelectorAll("span");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const submitBtn = document.getElementById("submitBtn");
      const addChildBtn = document.getElementById("add_child_btn");
      const childInputArea = document.getElementById("child_input_area");

      const sidoSelect = document.getElementById("sido");
      const sigunguSelect = document.getElementById("sigungu");

      let currentStep = 1;
      let childCount = 1;

      // --- ğŸš¨ ë°ì´í„° ì •ì˜ (2025ë…„ ê¸°ì¤€ ì¤‘ìœ„ì†Œë“ - ì‚¬ìš©ìê°€ ì œê³µí•œ ë°ì´í„° ê¸°ë°˜) ---
      const MEDIAN_INCOME_2025 = {
        1: 2392013,
        2: 3932658,
        3: 5025353,
        4: 6097773,
        5: 7108192,
        6: 8064805,
        7: 8988428,
      };

      // --- ğŸš¨ ì°¨ìƒìœ„ ê³„ì¸µ ê¸°ì¤€ (ì¤‘ìœ„ì†Œë“ 50% ì´í•˜) ---
      const NEAR_POVERTY_PERCENT = 50;

      // --- ë°ì´í„° ì •ì˜ (ì‹œ/ë„ë³„ ì‹œ/êµ°/êµ¬ ì˜µì…˜ - ê¸°ì¡´ ìœ ì§€) ---
      const districtData = {
        ì„œìš¸íŠ¹ë³„ì‹œ: [
          "ì¢…ë¡œêµ¬",
          "ì¤‘êµ¬",
          "ìš©ì‚°êµ¬",
          "ì„±ë™êµ¬",
          "ê´‘ì§„êµ¬",
          "ê¸°íƒ€ ì„œìš¸",
        ],
        ê²½ê¸°ë„: ["ìˆ˜ì›ì‹œ", "ì„±ë‚¨ì‹œ", "ê³ ì–‘ì‹œ", "ìš©ì¸ì‹œ", "í™”ì„±ì‹œ", "ê¸°íƒ€ ê²½ê¸°"],
        ë¶€ì‚°ê´‘ì—­ì‹œ: ["ì¤‘êµ¬", "ì„œêµ¬", "ë™êµ¬", "ì˜ë„êµ¬", "ë¶€ì‚°ì§„êµ¬", "ê¸°íƒ€ ë¶€ì‚°"],
        ì¸ì²œê´‘ì—­ì‹œ: [
          "ì¤‘êµ¬",
          "ë™êµ¬",
          "ë¯¸ì¶”í™€êµ¬",
          "ì—°ìˆ˜êµ¬",
          "ë‚¨ë™êµ¬",
          "ê¸°íƒ€ ì¸ì²œ",
        ],
        ìš¸ì‚°ê´‘ì—­ì‹œ: ["ì¤‘êµ¬", "ë‚¨êµ¬", "ë™êµ¬", "ë¶êµ¬", "ìš¸ì£¼êµ°"],
      };

      // --- ì¹© ìƒí˜¸ ë°°íƒ€ì  ë¡œì§ ì„¤ì • í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€) ---
      function setupMutuallyExclusiveChips(groupId) {
        const group = document.getElementById(groupId);
        if (!group) return;

        const noneChip = group.querySelector(`input[id$="_none"]`);
        const otherChips = group.querySelectorAll(
          'input[type="checkbox"]:not([id$="_none"])'
        );

        if (noneChip) {
          noneChip.onchange = () => {
            if (noneChip.checked) {
              otherChips.forEach((chip) => {
                chip.checked = false;
              });
            }
          };
        }

        otherChips.forEach((chip) => {
          chip.onchange = () => {
            if (chip.checked && noneChip) {
              noneChip.checked = false;
            }
          };
        });
      }

      // --- Flatpickr ì´ˆê¸°í™” í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€) ---
      function initializeFlatpickr(container = document) {
        const dateInputs = container.querySelectorAll(".flatpickr-input");

        dateInputs.forEach((input) => {
          if (input._flatpickr) {
            input._flatpickr.destroy();
          }

          flatpickr(input, {
            locale: "ko",
            dateFormat: "Y-m-d",
            allowInput: true,
            onReady: (selectedDates, dateStr, instance) => {
              input.addEventListener("focus", () => {
                if (!instance.isOpen) {
                  instance.open();
                }
              });
            },
          });
        });
      }

      // --- ìë…€ í•­ëª© ìƒì„± í•¨ìˆ˜ (ì™„ì„±) ---
      function createChildInput(count) {
        const deleteButtonHtml =
          count > 1
            ? `<button type="button" class="delete-child-btn" data-child-id="${count}">ì‚­ì œ</button>`
            : "";

        const schoolOptions = `
          <option value="newborn">ë¯¸ë“±ë¡/ì˜ìœ ì•„ (ë§Œ 0~2ì„¸)</option>
          <option value="preschool">ë¯¸ì·¨í•™ (ì–´ë¦°ì´ì§‘/ìœ ì¹˜ì› ì¬ì›)</option>
          <option value="elementary">ì´ˆë“±</option>
          <option value="middle">ì¤‘ë“±</option>
          <option value="high">ê³ ë“±</option>
          <option value="university">ëŒ€í•™êµ</option>
        `;

        return `
            <div class="child-item" data-child="${count}">
                ${deleteButtonHtml}
                <div style="clear: both;"></div> 
                <h4>ìë…€ ${count} ${
          count === 1 ? "(ëŒ€í‘œ ìë…€ë¡œ ì¡°ê±´ ë§¤í•‘)" : ""
        }</h4>
                <div class="form-group"><label for="child${count}_birth_date">ì¶œìƒì¼ (YYYY-MM-DD)</label>
                    <input type="text" id="child${count}_birth_date" name="child${count}_birth_date" 
                        data-required-group="child" class="flatpickr-input" placeholder="YYYY-MM-DD"></div> 
                
                <div class="form-group"><label for="child${count}_school">ì¬í•™/êµìœ¡ ìƒíƒœ</label>
                    <select id="child${count}_school" name="child${count}_school">${schoolOptions}</select>
                </div>

                <div class="form-group">
                    <label for="child${count}_disability">ì¥ì•  ì—¬ë¶€</label>
                    <select id="child${count}_disability" name="child${count}_disability">
                        <option value="N">í•´ë‹¹ ì—†ìŒ</option>
                        <option value="Y_severe">ì¥ì• ì¸ (ì¤‘ì¦)</option>
                        <option value="Y_mild">ì¥ì• ì¸ (ê²½ì¦)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ì•„ë™ ì§ˆí™˜ (DB ì»¬ëŸ¼: child_has_*_disease)</label>
                    <div class="chip-group" id="child${count}_health_chips">
                        <input type="checkbox" id="child${count}_health_none" name="child${count}_health[]" value="none" checked />
                        <label for="child${count}_health_none" class="chip">í•´ë‹¹ ì—†ìŒ</label>
                        <input type="checkbox" id="child${count}_health_serious" name="child${count}_health[]" value="serious" />
                        <label for="child${count}_health_serious" class="chip">ì¤‘ì¦ ì§ˆí™˜</label>
                        <input type="checkbox" id="child${count}_health_rare" name="child${count}_health[]" value="rare" />
                        <label for="child${count}_health_rare" class="chip">í¬ê·€ ì§ˆí™˜</label>
                        <input type="checkbox" id="child${count}_health_chronic" name="child${count}_health[]" value="chronic" />
                        <label for="child${count}_health_chronic" class="chip">ë‚œì¹˜ ì§ˆí™˜</label>
                        <input type="checkbox" id="child${count}_health_cancer" name="child${count}_health[]" value="cancer" />
                        <label for="child${count}_health_cancer" class="chip">ì•”/ë°±í˜ˆë³‘</label>
                        <input type="checkbox" id="child${count}_health_infertility" name="child${count}_health[]" value="infertility" />
                        <label for="child${count}_health_infertility" class="chip">ë‚œì„ (ê·¹íˆ ë“œë¬¾)</label>
                    </div>
                </div>
            </div>
        `;
      }

      // --- ìë…€ í•­ëª© ì‚­ì œ í•¨ìˆ˜ (ì™„ì„±) ---
      function deleteChildInput(e) {
        if (childCount <= 1) {
          alert("ìë…€ í•­ëª©ì€ ìµœì†Œ 1ê°œê°€ í•„ìš”í•©ë‹ˆë‹¤.");
          return;
        }
        const childItem = e.target.closest(".child-item");
        if (childItem) {
          childItem.remove();
          childCount--;
          updateChildIndices();
        }
      }

      // --- ìë…€ í•­ëª© ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì™„ì„±) ---
      function updateChildIndices() {
        const childItems = childInputArea.querySelectorAll(".child-item");
        childItems.forEach((item, index) => {
          const newIndex = index + 1;
          item.setAttribute("data-child", newIndex);
          item.querySelector("h4").textContent = `ìë…€ ${newIndex} ${
            newIndex === 1 ? "(ëŒ€í‘œ ìë…€ë¡œ ì¡°ê±´ ë§¤í•‘)" : ""
          }`;

          // Update input IDs and names
          item.querySelectorAll("[id]").forEach((el) => {
            el.id = el.id.replace(/child\d+/, `child${newIndex}`);
          });
          item.querySelectorAll("[name]").forEach((el) => {
            el.name = el.name.replace(/child\d+/, `child${newIndex}`);
          });
          item.querySelectorAll("label[for]").forEach((el) => {
            el.htmlFor = el.htmlFor.replace(/child\d+/, `child${newIndex}`);
          });

          // Update delete button data attribute
          const deleteBtn = item.querySelector(".delete-child-btn");
          if (deleteBtn) {
            deleteBtn.setAttribute("data-child-id", newIndex);
          }

          // Re-apply chip logic
          setupMutuallyExclusiveChips(`child${newIndex}_health_chips`);
        });

        // Ensure Flatpickr is initialized for new/renamed inputs
        initializeFlatpickr(childInputArea);
      }

      // --- ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì™„ì„±) ---
      function updateProgress() {
        const totalSteps = steps.length;
        const progress = (currentStep / totalSteps) * 100;
        progressFill.style.width = `${progress}%`;

        stepIndicators.forEach((indicator, index) => {
          indicator.classList.remove("active");
          if (index === currentStep - 1) {
            indicator.classList.add("active");
          }
        });
      }

      // --- ë‹¨ê³„ í‘œì‹œ í•¨ìˆ˜ (ì™„ì„±) ---
      function showStep(stepIndex) {
        steps.forEach((step, index) => {
          step.classList.remove("active");
          if (index === stepIndex - 1) {
            step.classList.add("active");
          }
        });
        currentStep = stepIndex;

        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        prevBtn.style.display = currentStep > 1 ? "inline-block" : "none";
        nextBtn.style.display =
          currentStep < steps.length ? "inline-block" : "none";
        submitBtn.style.display =
          currentStep === steps.length ? "inline-block" : "none";

        updateProgress();
      }

      // --- ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜ (ì™„ì„±) ---
      function validateStep(stepIndex) {
        const currentStepEl = steps[stepIndex - 1];
        let isValid = true;

        // ëª¨ë“  ì…ë ¥ í•„ë“œì— .input-error í´ë˜ìŠ¤ ì œê±°
        currentStepEl
          .querySelectorAll(".input-error")
          .forEach((el) => el.classList.remove("input-error"));

        // data-required="true" í•„ë“œ ê²€ì‚¬
        const requiredFields = currentStepEl.querySelectorAll(
          "[data-required='true']"
        );
        requiredFields.forEach((field) => {
          if (field.value.trim() === "") {
            field.classList.add("input-error");
            isValid = false;
          }
        });

        // Step 3 (ìë…€ ì •ë³´) íŠ¹ìˆ˜ ê²€ì‚¬: ìë…€ í•­ëª© ë‚´ data-required-group="child" í•„ë“œ ê²€ì‚¬
        if (stepIndex === 3) {
          const childRequiredFields = currentStepEl.querySelectorAll(
            "[data-required-group='child']"
          );
          childRequiredFields.forEach((field) => {
            if (field.value.trim() === "") {
              field.classList.add("input-error");
              isValid = false;
            }
          });
        }

        if (!isValid) {
          // ê²½ê³  ë©”ì‹œì§€ ëŒ€ì‹  ì²« ë²ˆì§¸ ì—ëŸ¬ í•„ë“œë¡œ ìŠ¤í¬ë¡¤ (ê°œì„ )
          const firstError = currentStepEl.querySelector(".input-error");
          if (firstError) {
            firstError.scrollIntoView({ behavior: "smooth", block: "center" });
            firstError.focus();
            alert("í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”.");
          }
        }

        return isValid;
      }

      // --- ë°ì´í„° ìˆ˜ì§‘ ë° ì „ì†¡ í•¨ìˆ˜ (ìˆ˜ì •ë¨) ---
      function handleSubmit(e) {
        e.preventDefault();
        if (!validateStep(currentStep)) return;

        const data = {};
        const formData = new FormData(form);

        // 1. ê¸°ë³¸ í•­ëª© ìˆ˜ì§‘ ë° ì „ì²˜ë¦¬ (form í•„ë“œëª…ì„ keyë¡œ ì‚¬ìš©)
        for (const [key, value] of formData.entries()) {
          // ë°°ì—´ í˜•íƒœë¡œ ì™€ì•¼ í•˜ëŠ” í•­ëª© (ì²´í¬ë°•ìŠ¤)
          if (key.endsWith("[]")) {
            const baseKey = key.slice(0, -2);
            if (!data[baseKey]) data[baseKey] = [];

            // ì¤‘ë³µ ë°©ì§€ ë¡œì§ (FormDataì˜ entriesëŠ” ì²´í¬ë°•ìŠ¤ë§ˆë‹¤ ê°™ì€ í‚¤ë¥¼ ë°˜í™˜í•¨)
            if (!data[baseKey].includes(value)) {
              data[baseKey].push(value);
            }
          } else if (key.startsWith("child")) {
            // ìë…€ í•­ëª©ì€ ì•„ë˜ì—ì„œ ë³„ë„ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ê±´ë„ˆëœ€
            continue;
          } else if (
            key === "monthly_income" ||
            key === "household_members_count" ||
            key === "residence_min_months"
          ) {
            // ìˆ«ì íƒ€ì…ìœ¼ë¡œ ë³€í™˜
            data[key] = parseInt(value.replace(/,/g, ""), 10) || 0;
          } else if (key === "is_near_poverty") {
            // ì²´í¬ë°•ìŠ¤: valueê°€ 'true'ì¼ ë•Œë§Œ trueë¡œ ì„¤ì •
            data[key] = value === "true";
          } else {
            data[key] = value;
          }
        }

        // --- ì²´í¬ë°•ìŠ¤ ë°°ì—´ ì •ì œ: 'none'ê³¼ ë‹¤ë¥¸ ê°’ì´ ê°™ì´ ìˆìœ¼ë©´ 'none' ì œê±° ---
        const arrayKeysToClean = [
          "household_type",
          "pregnancy_status",
          "parent_health",
          "special_status",
        ];
        arrayKeysToClean.forEach((key) => {
          if (data[key] && data[key].length > 1 && data[key].includes("none")) {
            data[key] = data[key].filter((v) => v !== "none");
          } else if (data[key] && data[key].length === 0) {
            data[key] = ["none"];
          }
        });

        // 2. ì†Œë“ ê¸°ì¤€ ê³„ì‚° ë° ë§¤í•‘
        const memberCount = data.household_members_count;
        const income = data.monthly_income;
        const isNearPoverty = data.is_near_poverty;
        // ê°€êµ¬ì› ìˆ˜ 7ì¸ ì´ˆê³¼ëŠ” 7ì¸ ê¸°ì¤€ ì‚¬ìš©
        const medianIncome =
          MEDIAN_INCOME_2025[memberCount] || MEDIAN_INCOME_2025[7];

        if (medianIncome) {
          const incomePercent = (income / medianIncome) * 100;
          data.income_max_percent = Math.ceil(incomePercent); // ì˜¬ë¦¼ ì²˜ë¦¬

          // ì†Œë“ ê¸°ì¤€ íƒ€ì… ê²°ì •
          if (incomePercent <= 30) {
            data.income_type = "ê¸°ì´ˆìƒí™œìˆ˜ê¸‰ì";
          } else if (incomePercent <= NEAR_POVERTY_PERCENT || isNearPoverty) {
            data.income_type = "ì°¨ìƒìœ„ê³„ì¸µ";
          } else if (incomePercent <= 70) {
            data.income_type = "ê¸°ì¤€ì¤‘ìœ„ì†Œë“70%";
          } else if (incomePercent <= 100) {
            data.income_type = "ê¸°ì¤€ì¤‘ìœ„ì†Œë“100%";
          } else if (incomePercent <= 150) {
            data.income_type = "ê¸°ì¤€ì¤‘ìœ„ì†Œë“150%";
          } else if (incomePercent <= 200) {
            data.income_type = "ê¸°ì¤€ì¤‘ìœ„ì†Œë“200%";
          } else {
            data.income_type = "ê¸°ì¤€ì™¸";
          }
        } else {
          data.income_type = "ê³„ì‚°ë¶ˆê°€(ê°€êµ¬ì›ìˆ˜ ì˜¤ë¥˜)";
          data.income_max_percent = 999;
        }

        // 3. ìë…€ í•­ëª© ë°ì´í„° ìˆ˜ì§‘ ë° í‚¤ ì¬ë§¤í•‘ (Child Array)
        const childArr = [];
        const childItems = childInputArea.querySelectorAll(".child-item");

        childItems.forEach((item, index) => {
          const childIndex = index + 1;
          const childData = {};

          // A. í•´ë‹¹ ìë…€ í•­ëª©ì˜ í•„ë“œë§Œ ìˆ˜ì§‘ (childN_... -> baseName)
          item
            .querySelectorAll(`[name^="child${childIndex}_"]`)
            .forEach((el) => {
              const name = el.name;
              // í•„ë“œëª… ì¶”ì¶œ (ì˜ˆ: child1_birth_date -> birth_date, child1_health[] -> health)
              let baseName = name
                .replace(`child${childIndex}_`, "")
                .replace("[]", "");

              if (el.type === "checkbox") {
                if (el.checked) {
                  if (!childData[baseName]) childData[baseName] = [];
                  childData[baseName].push(el.value);
                }
              } else if (
                el.tagName === "INPUT" ||
                el.tagName === "SELECT" ||
                el.tagName === "TEXTAREA"
              ) {
                // í…ìŠ¤íŠ¸/ë‚ ì§œ(Flatpickr)/ì…€ë ‰íŠ¸ ë°•ìŠ¤ ê°’ ì €ì¥
                childData[baseName] = el.value;
              }
            });

          // B. ìë…€ ê±´ê°• ì •ë³´ ë°°ì—´ ì •ì œ
          if (
            childData.health &&
            childData.health.length > 1 &&
            childData.health.includes("none")
          ) {
            childData.health = childData.health.filter((v) => v !== "none");
          } else if (childData.health && childData.health.length === 0) {
            childData.health = ["none"];
          }

          // C. ìµœì¢… DB ìŠ¤í‚¤ë§ˆì— ë§ê²Œ í‚¤ ì´ë¦„ ì¬ë§¤í•‘ (ìë…€ ë°°ì—´ ë‚´ë¶€)
          const finalChildData = {
            birth_date: childData.birth_date,
            birth_order: childIndex, // í¼ì—ëŠ” ì—†ìœ¼ë‚˜ indexë¡œ ì±„ì›€
            education_status: childData.school,
            disability_status: childData.disability,
            disease_status: childData.health || ["none"],
          };

          childArr.push(finalChildData);
        });

        // 4. ìµœì¢… ë°ì´í„° êµ¬ì¡°ì— ë°˜ì˜ ë° ë£¨íŠ¸ í‚¤ ì¬ë§¤í•‘
        const finalData = {
          sido: data.sido,
          sigungu: data.sigungu,
          residence_start_date: data.residence_start_date,
          residence_min_months: data.residence_min_months,
          household_type: data.household_type || ["none"],

          // Key Mismatches Renamed
          household_count: data.household_members_count,
          monthly_income_amount: data.monthly_income,
          is_near_poverty: data.is_near_poverty || false, // Ensure boolean
          housing_type: data.housing_type,
          maternity_status: data.pregnancy_status || ["none"],

          // Parent Info Mismatches Renamed
          parent_disability_status: data.parent_disability || "N",
          parent_disease_status: data.parent_health || ["none"],
          // Convert '1'/'0' string to boolean true/false
          is_grandparent_caring: data.requires_grandparent_care === "1",

          // Special Status
          special_status: data.special_status || ["none"],
          special_other: data.special_other,

          // Calculated fields
          income_max_percent: data.income_max_percent,
          income_type: data.income_type,

          // Child Array
          totalChildren: childArr.length,
          childArr: childArr,
        };

        console.log("=========================================");
        console.log("âœ… ìµœì¢… ìˆ˜ì§‘ ë°ì´í„° (ìš”ì²­ êµ¬ì¡° ë°˜ì˜):");
        console.log(finalData);
        console.log("=========================================");

        // ğŸš¨ TODO: ì—¬ê¸°ì— ì„œë²„ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ë¡œì§ì„ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.
        alert(
          "ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ! ì½˜ì†”(F12)ì—ì„œ ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n" +
            JSON.stringify(finalData, null, 2)
        );
      }

      // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë° ì´ˆê¸°í™” í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€) ---
      function initialize() {
        // Flatpickr ì´ˆê¸°í™”
        initializeFlatpickr();

        // ì‹œ/êµ°/êµ¬ ë™ì  ë¡œë“œ ì„¤ì •
        sidoSelect.addEventListener("change", (e) => {
          const selectedSido = e.target.value;
          sigunguSelect.innerHTML = '<option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>';
          if (districtData[selectedSido]) {
            districtData[selectedSido].forEach((district) => {
              const option = document.createElement("option");
              option.value = district;
              option.textContent = district;
              sigunguSelect.appendChild(option);
            });
          }
        });

        // ë‹¨ê³„ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        nextBtn.addEventListener("click", () => {
          if (validateStep(currentStep) && currentStep < steps.length) {
            showStep(currentStep + 1);
          }
        });

        prevBtn.addEventListener("click", () => {
          if (currentStep > 1) {
            showStep(currentStep - 1);
          }
        });

        // ìë…€ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        addChildBtn.addEventListener("click", () => {
          childCount++;
          const newChildHtml = createChildInput(childCount);
          childInputArea.insertAdjacentHTML("beforeend", newChildHtml);

          // ìƒˆë¡œìš´ ìš”ì†Œì— Flatpickr ë° ì¹© ë¡œì§ ì ìš©
          const newChildItem = childInputArea.lastElementChild;
          initializeFlatpickr(newChildItem);
          setupMutuallyExclusiveChips(`child${childCount}_health_chips`);

          // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°ì€ ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ëŒ€ì²´ (ì•„ë˜)
        });

        // ìë…€ í•­ëª© ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° (ì´ë²¤íŠ¸ ìœ„ì„)
        childInputArea.addEventListener("click", (e) => {
          if (e.target.classList.contains("delete-child-btn")) {
            deleteChildInput(e);
          }
        });

        // ì¹© ê·¸ë£¹ ìƒí˜¸ ë°°íƒ€ì  ë¡œì§ ì´ˆê¸°í™”
        setupMutuallyExclusiveChips("child1_health_chips");
        setupMutuallyExclusiveChips("parent_health_chips");

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        form.addEventListener("submit", handleSubmit);

        // ì´ˆê¸° ë‹¨ê³„ í‘œì‹œ
        showStep(1);
      }

      initialize();
    </script>
  </body>
</html>
